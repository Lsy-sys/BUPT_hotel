## Python 版酒店空调管理系统

该项目提供波普特酒店中央温控系统的 Python 实现，核心目标是：

- 提供“多用多付”空调计费能力，可查询详单、打印账单
- 管理入住/退房流程，自动结算住宿费与空调费
- 让系统管理员维护空调调度队列、模拟温度
- 为酒店经理输出运营报表，支撑 UC01-UC06 用例

技术栈：**Flask + SQLAlchemy + MySQL + Jinja2**，REST API 保持与原 Java 版本兼容。

---

### 功能概览

- **入住/退房**：`/api/hotel/*`
- **空调调度**：`/api/ac/*`，含启停、调温、调速、状态查询
- **账单管理**：`/api/bills/*`，含打印、导出详单
- **监控面板**：`/api/monitor/*` 提供房态与调度队列，前端位于 `templates/dashboard.html`
- **系统维护**：`/api/admin/*` 支持房间维修/恢复、强制轮转、温度模拟
- **运营报表**：`/api/reports/*` 输出经营概览、空调使用统计与营收趋势

详细接口参数请参考 `docs/api_reference.md`。

---

### 目录结构

```
hotel/
├─ app.py                # Flask 入口
├─ config.py             # 配置常量/环境变量
├─ controllers/          # 各类 REST 控制器
├─ services/             # 业务服务与调度逻辑
├─ models/               # SQLAlchemy ORM 模型
├─ database/             # schema.sql、初始化脚本
├─ templates/dashboard.html
├─ static/styles.css
└─ docs/api_reference.md # 接口说明（新增）
```

---

### 环境配置

| 变量 | 默认值                                                                            | 说明 |
| --- |--------------------------------------------------------------------------------| --- |
| `DATABASE_URL` | `mysql+pymysql://root:yourpassword@localhost:3306/hotel_ac_db?charset=utf8mb4` | MySQL 连接串 |
| `HOTEL_AC_TOTAL_COUNT` | `3`                                                                            | 可同时服务的空调实例数 |
| `HOTEL_ROOM_COUNT` | `5`                                                                            | 自动初始化的房间数量 |
| `HOTEL_DEFAULT_TEMP` | `25`                                                                           | 入住默认室温 |
| `HOTEL_TIME_SLICE` | `120`                                                                          | 调度轮转时间片（秒） |
| `BILLING_ROOM_RATE` | `100`                                                                          | 住宿费（元/天） |
| `BILLING_AC_RATE_LOW/MEDIUM/HIGH` | `0.5 / 1.0 / 1.5`                                                              | 按风速计费（元/分钟） |

---

### 快速启动

1. 安装依赖
   ```bash
   pip install -r hotel/requirements.txt
   ```
2. 初始化数据库（自动执行 `schema.sql` 并写入基础配置、房间数据）
   ```bash
   python -m hotel.database.init_db
   ```
3. 运行服务
   ```bash
   python -m hotel.app
   ```

服务启动后：

- API 前缀统一为 `/api/*`
- 访问 `http://localhost:8080/` 进入系统主入口页面
- 系统提供基于角色的多页面界面，不同用户可访问对应功能页面

---

## 系统使用指南

### 主入口页面

访问 `http://localhost:8080/` 后，系统会显示角色选择界面，包含以下四个入口：

1. **客户** - 使用客房空调服务
2. **前台营业员** - 办理入住、退房业务
3. **系统管理员** - 监控系统、维护设备
4. **酒店经理** - 查看经营报表

---

### 一、客户使用指南

**访问路径**：`http://localhost:8080/customer`

#### 1.1 选择房间
- 客户办理入住后，在下拉框中选择自己的房间号
- 系统仅显示已入住（OCCUPIED）状态的房间
- 选择房间后，界面会显示该房间的空调状态信息

#### 1.2 开启/关闭空调
- 点击 **"开启空调"** 按钮启动空调服务
- 系统会自动将请求加入调度队列（服务队列或等待队列）
- 点击 **"关闭空调"** 按钮停止服务，系统自动计算费用并记录详单

#### 1.3 调节温度
- 在温度输入框中输入目标温度（18-30°C）
- 点击 **"设置温度"** 按钮
- **注意**：必须先开启空调才能设置温度
- 系统会实时更新目标温度，当前温度会逐步向目标温度调整

#### 1.4 调节风速
- 在下拉框中选择风速：低风（LOW）、中风（MEDIUM）、高风（HIGH）
- 点击 **"设置风速"** 按钮
- 不同风速对应不同的计费费率（低风 0.5元/分钟，中风 1.0元/分钟，高风 1.5元/分钟）

#### 1.5 查看使用统计
- 界面自动显示累计使用时长和累计费用
- 数据每 3 秒自动刷新一次
- 费用按实际使用时长和风速费率计算

---

### 二、前台营业员使用指南

**访问路径**：`http://localhost:8080/reception`

#### 2.1 办理入住

1. 在 **"办理入住"** 卡片中：
   - 选择可用房间（系统仅显示状态为"空闲"的房间）
   - 填写客户姓名（必填）
   - 填写身份证号（可选）
   - 填写联系电话（可选）
2. 点击 **"办理入住"** 按钮
3. 系统会：
   - 将房间状态更新为"已入住"
   - 创建客户记录
   - 关联房间与客户
   - 返回成功提示

#### 2.2 办理退房

1. 在 **"办理退房"** 卡片中：
   - 选择要退房的房间（系统仅显示"已入住"状态的房间）
2. 点击 **"办理退房"** 按钮
3. 系统会：
   - 自动计算住宿费（按入住天数 × 100元/天）
   - 汇总所有空调使用详单，计算空调费
   - 生成完整账单
   - 在界面下方显示账单详情（包含住宿费、空调费、总金额）
   - 将房间状态更新为"空闲"

#### 2.3 查看房间状态

- 页面下方显示所有房间的实时状态表格
- 包含：房间号、状态、客户姓名、入住时间
- 可直接在表格中点击 **"退房"** 或 **"快速入住"** 按钮进行操作
- 点击 **"刷新"** 按钮更新房间状态

---

### 三、系统管理员使用指南

**访问路径**：`http://localhost:8080/admin`

#### 3.1 房间状态监控

- 查看所有房间的实时状态：
  - 房间ID、状态（空闲/已入住/维修中）
  - 当前温度、目标温度、风速
  - 空调开关状态
  - 调度队列状态（服务中/等待中/空闲）
- 数据每 5 秒自动刷新一次
- 点击 **"刷新"** 按钮手动更新

#### 3.2 调度队列管理

- 查看 **服务队列**：当前正在服务的房间列表
- 查看 **等待队列**：等待服务的房间列表
- 队列按优先级（风速）和时间片轮转规则自动调度

#### 3.3 房间维护

1. **标记房间为维修**：
   - 在"房间维护"卡片中输入房间号
   - 点击 **"标记维修"** 按钮
   - **注意**：只能对空闲（AVAILABLE）状态的房间执行此操作
   - 系统会自动关闭该房间的空调（如果开启）

2. **恢复房间可用**：
   - 输入处于"维修中"状态的房间号
   - 点击 **"恢复可用"** 按钮
   - 房间状态恢复为"空闲"，可重新接待客户

#### 3.4 系统运维

1. **强制轮转调度队列**：
   - 点击 **"强制轮转"** 按钮
   - 系统立即执行时间片轮转，将等待队列中的房间提升到服务队列
   - 适用于需要立即调整调度优先级的情况

2. **模拟温度更新**：
   - 点击 **"模拟温度更新"** 按钮
   - 系统模拟所有房间的温度变化过程
   - 开启空调的房间温度会逐步向目标温度调整
   - 未开启的房间温度会逐步回归到默认温度

---

### 四、酒店经理使用指南

**访问路径**：`http://localhost:8080/manager`

#### 4.1 时间范围筛选

- 在页面顶部设置开始日期和结束日期
- 点击 **"应用筛选"** 按钮，报表数据会按时间范围过滤
- 点击 **"重置"** 按钮清除筛选条件

#### 4.2 运营概览

查看以下关键指标：
- **总房间数**：酒店房间总数
- **已入住**：当前已入住房间数及入住率
- **维修中**：处于维修状态的房间数
- **住宿费收入**：选定时间范围内的住宿费总收入
- **空调费收入**：选定时间范围内的空调费总收入
- **总收入**：住宿费 + 空调费
- **账单数量**：生成的账单总数及平均空调费

#### 4.3 空调使用统计

查看空调使用情况：
- **总使用次数**：空调开启的总次数
- **总使用时长**：累计使用分钟数
- **总费用**：空调费总收入
- **按风速统计**：不同风速（LOW/MEDIUM/HIGH）的使用时长和费用明细

#### 4.4 每日营收趋势

- 选择查看天数：最近 7 天 / 14 天 / 30 天
- 查看每日的：
  - 住宿费收入
  - 空调费收入
  - 总收入
- 数据按日期倒序排列，便于分析营收趋势

---

## 打印与导出功能

### 打印账单

#### 方法一：通过 API 接口

**接口**：`POST /api/bills/<billId>/print`

**使用步骤**：

1. **获取账单ID**：
   - 办理退房时，系统会返回账单信息，其中包含 `bill.id`
   - 或通过 `GET /api/bills` 查询所有账单，找到目标账单的 ID

2. **调用打印接口**：
   ```bash
   curl -X POST http://localhost:8080/api/bills/1/print
   ```

3. **返回数据格式**：
   ```json
   {
     "bill": {
       "id": 1,
       "roomId": 1,
       "checkInTime": "2025-01-20T10:00:00",
       "checkOutTime": "2025-01-21T14:00:00",
       "stayDays": 1,
       "roomFee": 100.0,
       "acFee": 45.0,
       "totalAmount": 145.0,
       "status": "UNPAID",
       "printStatus": "PRINTED",
       "printTime": "2025-01-21T14:30:00"
     },
     "detailItems": [
       {
         "startTime": "2025-01-20T15:00:00",
         "endTime": "2025-01-20T15:30:00",
         "durationMinutes": 30,
         "fanSpeed": "HIGH",
         "mode": "COOLING",
         "rate": 1.5,
         "cost": 45.0
       }
     ],
     "totals": {
       "acDurationMinutes": 30,
       "acFee": 45.0,
       "roomFee": 100.0,
       "grandTotal": 145.0
     }
   }
   ```

4. **处理打印数据**：
   - 前端可接收此 JSON 数据，使用 JavaScript 的 `window.print()` 或打印库（如 jsPDF）生成 PDF
   - 后端可集成模板引擎（如 Jinja2）渲染 HTML 打印模板
   - 或使用第三方打印服务（如打印机 API）直接打印

#### 方法二：在前台页面打印

1. 办理退房后，系统会在界面显示账单详情
2. 右键点击账单详情区域，选择"打印"
3. 或使用浏览器快捷键 `Ctrl+P`（Windows）或 `Cmd+P`（Mac）打印当前页面

### 导出空调详单（CSV）

**接口**：`GET /api/bills/<billId>/export-details`

**使用步骤**：

1. **获取账单ID**（同打印步骤）

2. **调用导出接口**：
   ```bash
   curl -X GET http://localhost:8080/api/bills/1/export-details -o bill_1_details.csv
   ```
   或在浏览器中直接访问：
   ```
   http://localhost:8080/api/bills/1/export-details
   ```

3. **CSV 文件格式**：
   ```csv
   房间号,开始时间,结束时间,时长(分钟),风速,模式,费率,费用
   1,2025-01-20T15:00:00,2025-01-20T15:30:00,30,HIGH,COOLING,1.5,45.0
   ```

4. **使用场景**：
   - 客户需要详细的空调使用记录
   - 财务对账需要明细数据
   - 数据分析需要结构化数据
   - 可导入 Excel 进行进一步处理

### 打印状态说明

- **printStatus** 字段：
  - `NOT_PRINTED`：未打印（默认状态）
  - `PRINTED`：已打印
- 调用打印接口后，系统会自动将账单标记为"已打印"，并记录打印时间
- 可通过 `GET /api/bills/<billId>` 查询账单的打印状态

---

## 开发与调试

### 数据库管理

- **初始化数据库**：
  ```bash
  python -m hotel.database.init_db
  ```
  此命令会：
  - 执行 `database/schema.sql` 创建所有表结构
  - 初始化空调配置数据（制冷/制热模式）
  - 创建默认房间数据（数量由 `HOTEL_ROOM_COUNT` 配置决定）

- **重置数据库**：
  - 可重复执行 `init_db` 命令，会先删除旧表再重建
  - 或手动删除数据库后重新初始化

### 测试接口

系统提供了测试接口（`/api/test/*`），便于开发调试：

- `POST /api/test/reset`：重置所有房间状态为初始状态
- `POST /api/test/time-slice-check`：手动触发时间片检查
- `POST /api/test/temperature-update`：手动触发温度模拟更新
- `GET /api/test/rooms/status`：查看所有房间状态
- `GET /api/test/rooms/<roomId>/status`：查看指定房间状态

### 调试模式

- 运行服务时，`app.py` 默认启用 `debug=True`
- 修改代码后会自动重载
- 错误信息会显示详细堆栈跟踪

---

## 常见问题

### Q1: 客户无法设置温度？
**A**: 请确保已先开启空调。系统要求必须先开启空调才能设置目标温度。

### Q2: 为什么房间一直显示"空闲"，无法办理入住？
**A**: 检查房间是否处于"维修中"状态。只有"空闲"状态的房间才能办理入住。

### Q3: 如何查看某个客户的完整消费记录？
**A**: 使用 `GET /api/bills/customer/<customerId>` 接口查询该客户的所有账单。

### Q4: 打印功能如何集成到实际打印机？
**A**: 
- 前端方案：使用浏览器打印 API（`window.print()`）或 jsPDF 生成 PDF
- 后端方案：使用模板引擎渲染 HTML，通过无头浏览器（如 Puppeteer）生成 PDF，再发送到打印机
- 第三方方案：集成打印机厂商的 API（如云打印服务）

### Q5: 空调调度队列如何工作？
**A**: 
- 系统最多同时服务 `HOTEL_AC_TOTAL_COUNT` 个房间（默认 3 个）
- 超出容量的请求会进入等待队列
- 系统按优先级（风速：HIGH > MEDIUM > LOW）和时间片（默认 120 秒）进行轮转
- 高优先级请求会抢占低优先级请求的服务位置

---

## 后续方向

- 完善自动化测试（当前暂无）
- 对接真实前端/物联网设备，替换模拟温度逻辑
- 接入身份认证与角色权限控制，限制维护/报表接口的访问
- 支持多酒店/多分店管理
- 增加数据可视化图表（营收趋势图、使用率统计图等）
- 支持批量导出报表（Excel/PDF）

