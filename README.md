# 酒店空调管理系统

## 项目简介

本项目是一个基于 Python Flask 框架开发的酒店中央空调管理系统，实现了完整的酒店入住管理、空调调度、计费结算和运营报表功能。系统采用 B/S 架构，前后端分离设计，支持多角色用户（客户、前台营业员、系统管理员、酒店经理）的差异化功能需求。

### 核心功能

- **入住/退房管理**：完整的客户登记、房间分配、退房结算流程
- **空调调度系统**：基于优先级队列和时间片轮转的智能调度算法
- **计费系统**：支持"多用多付"的空调计费，自动生成详单和账单
- **实时监控**：房间状态、温度变化、调度队列的实时监控
- **运营报表**：经营概览、空调使用统计、营收趋势分析
- **系统维护**：房间维修管理、强制调度轮转、温度模拟

### 技术栈

- **后端框架**：Flask 3.0.3
- **ORM**：SQLAlchemy 3.1.1
- **数据库**：MySQL（通过 PyMySQL 连接）
- **前端技术**：HTML + JavaScript + CSS + jQuery
- **架构模式**：MVC + 服务层 + 调度层

---

## 快速开始

### 环境要求

- Python 3.8+
- MySQL 5.7+ 或 8.0+
- pip 包管理器

### 安装步骤

1. **克隆项目并安装依赖**

```bash
pip install -r requirements.txt
```

2. **配置数据库连接**

编辑 `config.py` 或设置环境变量：

```bash
export DATABASE_URL="mysql+pymysql://root:yourpassword@localhost:3306/hotel_ac_db?charset=utf8mb4"
```

3. **初始化数据库**

```bash
python -m hotel.database.init_db
```

此命令会：
- 创建所有数据库表结构
- 初始化空调配置数据（制冷/制热模式）
- 创建默认房间数据（数量由配置决定）

4. **启动服务**

```bash
python -m hotel.app
```

服务启动后访问：`http://localhost:8080`

---

## 系统配置

### 环境变量配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `DATABASE_URL` | `mysql+pymysql://root:abc123456@localhost:3306/hotel_ac_db?charset=utf8mb4` | MySQL 数据库连接串 |
| `HOTEL_AC_TOTAL_COUNT` | `3` | 可同时服务的空调实例数（调度容量） |
| `HOTEL_ROOM_COUNT` | `5` | 自动初始化的房间数量 |
| `HOTEL_DEFAULT_TEMP` | `25` | 入住默认室温（℃） |
| `HOTEL_TIME_SLICE` | `120` | 调度轮转时间片（秒） |
| `BILLING_ROOM_RATE` | `100.0` | 住宿费（元/天） |
| `BILLING_AC_RATE_LOW` | `0.3333333333` | 低风速计费（元/分钟） |
| `BILLING_AC_RATE_MEDIUM` | `0.5` | 中风速计费（元/分钟） |
| `BILLING_AC_RATE_HIGH` | `1.0` | 高风速计费（元/分钟） |
| `TIME_ACCELERATION_FACTOR` | `6.0` | 时间加速因子（测试用） |

### 空调模式配置

- **制冷模式**：温度范围 18-28℃，默认目标温度 25℃
- **制热模式**：温度范围 18-25℃，默认目标温度 23℃

---

## 目录结构

```
hotel/
├── app.py                    # Flask 应用入口
├── config.py                 # 配置管理
├── extensions.py             # Flask 扩展初始化
├── __init__.py              # 应用工厂函数
│
├── controllers/             # REST API 控制器层
│   ├── ac_controller.py     # 空调控制接口
│   ├── admin_controller.py  # 管理员维护接口
│   ├── bill_controller.py   # 账单管理接口
│   ├── hotel_controller.py  # 酒店业务接口
│   ├── monitor_controller.py # 监控接口
│   ├── report_controller.py # 报表接口
│   └── test_controller.py    # 测试调试接口
│
├── services/                # 业务服务层
│   ├── ac_service.py        # 空调服务
│   ├── scheduler.py         # 调度器核心
│   ├── hotel_service.py     # 前台服务（FrontDesk）
│   ├── room_service.py      # 房间服务
│   ├── customer_service.py  # 客户服务
│   ├── bill_service.py      # 账单服务
│   ├── bill_detail_service.py # 详单服务
│   ├── maintenance_service.py # 维护服务
│   └── report_service.py    # 报表服务
│
├── models/                  # 数据模型层
│   └── __init__.py          # SQLAlchemy ORM 模型定义
│
├── database/                # 数据库相关
│   ├── schema.sql           # 数据库表结构 SQL
│   └── init_db.py          # 数据库初始化脚本
│
├── vo/                      # 值对象（Value Objects）
│   └── checkout_response.py # 退房响应对象
│
├── templates/               # HTML 模板
│   ├── index.html          # 首页（角色选择）
│   ├── customer.html       # 客户界面
│   ├── reception.html      # 前台界面
│   ├── checkin.html        # 入住办理页面
│   ├── checkout.html      # 退房办理页面
│   ├── admin.html          # 管理员界面
│   └── manager.html        # 经理界面
│
├── static/                 # 静态资源
│   ├── css/               # 样式文件
│   └── js/                # JavaScript 脚本
│
├── docs/                   # 文档
│   ├── api_reference.md   # API 接口文档
│   └── architecture_analysis.md # 架构分析文档
│
├── case_test/              # 测试用例
│   ├── test_cool.py       # 制冷模式测试
│   └── test_heat.py       # 制热模式测试
│
└── requirements.txt        # Python 依赖列表
```

---

## API 接口概览

系统提供以下 RESTful API 接口组：

- **空调控制** (`/ac/*`)：开启/关闭空调、调节温度/风速/模式、查询状态
- **酒店业务** (`/hotel/*`)：办理入住、退房、查询可用房间
- **账单管理** (`/bill/*`)：查询账单、导出详单 CSV
- **系统监控** (`/monitor/*`)：查看调度队列状态
- **管理员维护** (`/admin/*`)：房间维护、系统控制、数据库重置
- **运营报表** (`/report/*`)：房间报表、日报、周报
- **测试调试** (`/test/*`)：测试专用接口

详细接口文档请参考：[API 接口文档](docs/api_reference.md)

---

## 系统使用指南

### 主入口页面

访问 `http://localhost:8080/` 进入系统首页，系统提供四个角色入口：

1. **客户** - 使用客房空调服务
2. **前台营业员** - 办理入住、退房业务
3. **系统管理员** - 监控系统、维护设备
4. **酒店经理** - 查看经营报表

---

### 一、客户使用指南

**访问路径**：`http://localhost:8080/customer`

#### 功能说明

1. **选择房间**
   - 下拉框仅显示已入住（OCCUPIED）状态的房间
   - 选择后自动显示该房间的空调状态信息

2. **开启/关闭空调**
   - 点击"开启空调"按钮启动服务
   - 系统自动将请求加入调度队列（服务队列或等待队列）
   - 点击"关闭空调"停止服务，自动计算费用并记录详单

3. **调节温度**
   - 输入目标温度（18-30℃）
   - 点击"设置温度"按钮
   - **注意**：必须先开启空调才能设置温度
   - 当前温度会逐步向目标温度调整

4. **调节风速**
   - 选择风速：低风（LOW）、中风（MEDIUM）、高风（HIGH）
   - 不同风速对应不同计费费率
   - 高风速优先级更高，可抢占低风速的服务位置

5. **切换模式**
   - 支持制冷（COOLING）和制热（HEATING）两种模式
   - 切换模式会自动重置目标温度为该模式的默认值

6. **查看使用统计**
   - 界面自动显示累计使用时长和累计费用
   - 数据每 3 秒自动刷新
   - 费用按实际使用时长和风速费率计算

---

### 二、前台营业员使用指南

**访问路径**：`http://localhost:8080/reception`

#### 办理入住

1. 在"办理入住"卡片中：
   - 选择可用房间（仅显示"空闲"状态的房间）
   - 填写客户姓名（必填）
   - 填写身份证号（可选）
   - 填写联系电话（可选）

2. 点击"办理入住"按钮

3. 系统会：
   - 将房间状态更新为"已入住"
   - 创建客户记录
   - 关联房间与客户
   - 返回成功提示

#### 办理退房

1. 在"办理退房"卡片中：
   - 选择要退房的房间（仅显示"已入住"状态的房间）

2. 点击"办理退房"按钮

3. 系统会：
   - 自动计算住宿费（按入住天数 × 日房费）
   - 汇总所有空调使用详单，计算空调费
   - 生成完整账单
   - 在界面显示账单详情（包含住宿费、空调费、总金额）
   - 将房间状态更新为"空闲"
   - 如果空调正在运行，会自动关闭并结算

#### 查看房间状态

- 页面显示所有房间的实时状态表格
- 包含：房间号、状态、客户姓名、入住时间
- 可直接在表格中点击"退房"或"快速入住"按钮
- 点击"刷新"按钮更新房间状态

---

### 三、系统管理员使用指南

**访问路径**：`http://localhost:8080/admin`

#### 房间状态监控

- 查看所有房间的实时状态：
  - 房间ID、状态（空闲/已入住/维修中）
  - 当前温度、目标温度、风速
  - 空调开关状态、模式（制冷/制热）
  - 调度队列状态（服务中/等待中/空闲）
- 数据每 5 秒自动刷新
- 点击"刷新"按钮手动更新

#### 调度队列管理

- 查看**服务队列**：当前正在服务的房间列表
- 查看**等待队列**：等待服务的房间列表
- 队列按优先级（风速：HIGH > MEDIUM > LOW）和时间片轮转规则自动调度

#### 房间维护

1. **标记房间为维修**
   - 输入房间号
   - 点击"标记维修"按钮
   - **注意**：只能对空闲（AVAILABLE）状态的房间执行此操作
   - 系统会自动关闭该房间的空调（如果开启）

2. **恢复房间可用**
   - 输入处于"维修中"状态的房间号
   - 点击"恢复可用"按钮
   - 房间状态恢复为"空闲"，可重新接待客户

#### 系统运维

1. **强制轮转调度队列**
   - 点击"强制轮转"按钮
   - 系统立即执行时间片轮转，将等待队列中的房间提升到服务队列
   - 适用于需要立即调整调度优先级的情况

2. **模拟温度更新**
   - 点击"模拟温度更新"按钮
   - 系统模拟所有房间的温度变化过程
   - 开启空调的房间温度会逐步向目标温度调整
   - 未开启的房间温度会逐步回归到默认温度

3. **重置数据库**（调试用）
   - 点击"重置数据库"按钮
   - 清空所有数据并重新初始化
   - **警告**：此操作会删除所有历史数据

---

### 四、酒店经理使用指南

**访问路径**：`http://localhost:8080/manager`

#### 房间报表

- 选择房间号，查看该房间的详细使用报表
- 包含：使用时长、费用统计、详单记录

#### 日报表

- 选择日期（YYYY-MM-DD 格式）
- 查看该日的经营数据：
  - 入住房间数
  - 住宿费收入
  - 空调费收入
  - 总收入

#### 周报表

- 选择起始日期
- 查看最近一周的经营数据汇总

---

## 核心功能说明

### 空调调度算法

系统采用**优先级队列 + 时间片轮转**的调度策略：

1. **优先级规则**：按风速优先级排序（HIGH > MEDIUM > LOW）
2. **容量限制**：最多同时服务 `HOTEL_AC_TOTAL_COUNT` 个房间（默认 3 个）
3. **时间片轮转**：每个房间服务 `HOTEL_TIME_SLICE` 秒（默认 120 秒）后自动轮转
4. **抢占机制**：高优先级请求可以抢占低优先级请求的服务位置

### 温度模拟计算

系统根据风速自动计算温度变化：

- **高风速**：1 分钟降/升 1℃
- **中风速**：1 分钟降/升 0.5℃
- **低风速**：1 分钟降/升 1/3℃（约 0.333℃）

当空调关闭时，温度会自然回归到默认温度（25℃）。

### 计费规则

1. **住宿费**：按入住天数 × 日房费（默认 100 元/天）
2. **空调费**：按实际使用时长 × 风速费率
   - 低风速：0.333 元/分钟
   - 中风速：0.5 元/分钟
   - 高风速：1.0 元/分钟
3. **详单记录**：每次空调开启-关闭周期生成一条详单记录

---

## 数据导出功能

### 导出空调详单（CSV）

**接口**：`GET /bill/export/csv?roomId=<roomId>`

**使用步骤**：

1. 调用接口（可指定房间号，不指定则导出所有房间）
2. 浏览器会自动下载 CSV 文件
3. CSV 文件包含：房间号、开始时间、结束时间、时长、风速、模式、费率、费用、类型

**CSV 格式示例**：

```csv
房间号,开始时间,结束时间,时长(分钟),风速,模式,费率,费用,类型
1,2025-01-20 15:00:00,2025-01-20 15:30:00,30,HIGH,COOLING,1.0,30.0,空调运行
```

---

## 开发与调试

### 数据库管理

- **初始化数据库**：
  ```bash
  python -m hotel.database.init_db
  ```

- **重置数据库**：
  - 通过管理员界面点击"重置数据库"按钮
  - 或重复执行 `init_db` 命令（会先删除旧表再重建）

### 测试接口

系统提供了测试接口（`/test/*`），便于开发调试：

- `POST /test/initRoom`：初始化房间温度（测试用）
- 其他测试接口请参考 API 文档

### 调试模式

- 运行服务时，`app.py` 默认启用 `debug=True`
- 修改代码后会自动重载
- 错误信息会显示详细堆栈跟踪

---

## 常见问题

### Q1: 客户无法设置温度？

**A**: 请确保已先开启空调。系统要求必须先开启空调才能设置目标温度。

### Q2: 为什么房间一直显示"空闲"，无法办理入住？

**A**: 检查房间是否处于"维修中"状态。只有"空闲"状态的房间才能办理入住。

### Q3: 如何查看某个客户的完整消费记录？

**A**: 通过账单服务查询该客户关联的所有账单记录。

### Q4: 空调调度队列如何工作？

**A**: 
- 系统最多同时服务 `HOTEL_AC_TOTAL_COUNT` 个房间（默认 3 个）
- 超出容量的请求会进入等待队列
- 系统按优先级（风速：HIGH > MEDIUM > LOW）和时间片（默认 120 秒）进行轮转
- 高优先级请求会抢占低优先级请求的服务位置

### Q5: 温度变化速度如何控制？

**A**: 温度变化速度由风速决定，系统会自动根据风速计算温度变化。可通过管理员界面的"模拟温度更新"按钮手动触发温度计算。

---

## 后续开发方向

- [ ] 完善自动化测试（单元测试、集成测试）
- [ ] 对接真实前端/物联网设备，替换模拟温度逻辑
- [ ] 接入身份认证与角色权限控制
- [ ] 支持多酒店/多分店管理
- [ ] 增加数据可视化图表（营收趋势图、使用率统计图等）
- [ ] 支持批量导出报表（Excel/PDF）
- [ ] 实现 WebSocket 实时推送，替代轮询机制
- [ ] 添加操作日志和审计功能

---

## 相关文档

- [API 接口文档](docs/api_reference.md) - 完整的 REST API 接口说明
- [架构分析文档](docs/architecture_analysis.md) - 系统架构设计说明

---

## 许可证

本项目为教学演示项目，仅供学习参考使用。
